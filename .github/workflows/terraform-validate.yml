name: Terraform Validation

on:
  pull_request:
    branches: [ master, main ]
    paths:
      - 'terraform/**'
      - 'infra/**'
      - '.github/workflows/terraform-validate.yml'
  push:
    branches: [ master, main ]
    paths:
      - 'terraform/**'
      - 'infra/**'
  workflow_dispatch:

env:
  TERRAFORM_VERSION: '1.9.0'
  BICEP_VERSION: 'latest'

jobs:
  validate-bicep:
    name: Validate Bicep Templates
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Azure CLI
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
        continue-on-error: true

      - name: Setup Bicep CLI
        run: |
          az bicep install
          az bicep version

      - name: Lint Bicep Files
        run: |
          echo "Linting Bicep files..."
          for file in $(find infra -name "*.bicep"); do
            echo "Linting $file"
            az bicep lint --file "$file"
          done

      - name: Build Bicep Templates
        run: |
          echo "Building Bicep templates to validate syntax..."
          az bicep build --file infra/main.bicep
          echo "âœ… Bicep validation successful"

      - name: Check for Bicep Best Practices
        run: |
          echo "Checking for common issues..."
          # Check for hardcoded values
          if grep -r "contoso\|example\.com\|changeme" infra --include="*.bicep"; then
            echo "âš ï¸ Warning: Found placeholder values in Bicep files"
            exit 1
          fi
          echo "âœ… No placeholder values found"

  validate-terraform:
    name: Validate Terraform Configuration
    runs-on: ubuntu-latest
    strategy:
      matrix:
        directory: ['terraform/metastore', 'terraform/environments']
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Format Check
        id: fmt
        run: |
          cd ${{ matrix.directory }}
          terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Init
        id: init
        run: |
          cd ${{ matrix.directory }}
          terraform init -backend=false

      - name: Terraform Validate
        id: validate
        run: |
          cd ${{ matrix.directory }}
          terraform validate -no-color

      - name: Check for Sensitive Data
        run: |
          echo "Checking for accidentally committed secrets..."
          if grep -r "password\s*=\s*\"[^$]" terraform --include="*.tf" --include="*.tfvars"; then
            echo "âš ï¸ Warning: Possible hardcoded password found"
            exit 1
          fi
          if grep -r "client_secret\s*=\s*\"" terraform --include="*.tf" --include="*.tfvars"; then
            echo "âš ï¸ Warning: Possible hardcoded client secret found"
            exit 1
          fi
          echo "âœ… No hardcoded secrets detected"

      - name: Comment PR (Format)
        if: github.event_name == 'pull_request' && steps.fmt.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `#### ðŸ” Terraform Format Check Failed for \`${{ matrix.directory }}\`
              
              Please run \`terraform fmt -recursive\` to format your code.
              
              \`\`\`
              cd ${{ matrix.directory }}
              terraform fmt -recursive
              \`\`\`
              `
            })

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run Trivy IaC Scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
        continue-on-error: true

      - name: Upload Trivy Results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true

      - name: Run Checkov IaC Scanner
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          framework: terraform,bicep
          output_format: cli
          soft_fail: true
          skip_check: CKV_AZURE_33,CKV_AZURE_35  # Skip specific checks if needed

  documentation-check:
    name: Documentation Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Check Required Documentation
        run: |
          echo "Checking for required documentation files..."
          required_docs=(
            "README.md"
            "terraform/README.md"
            "infra/main.bicepparam"
          )
          
          missing_docs=()
          for doc in "${required_docs[@]}"; do
            if [ ! -f "$doc" ]; then
              missing_docs+=("$doc")
            fi
          done
          
          if [ ${#missing_docs[@]} -ne 0 ]; then
            echo "âŒ Missing required documentation:"
            printf '%s\n' "${missing_docs[@]}"
            exit 1
          fi
          echo "âœ… All required documentation present"

      - name: Check for TODOs
        run: |
          echo "Checking for TODO items..."
          todos=$(grep -r "TODO\|FIXME" terraform infra --include="*.tf" --include="*.bicep" || true)
          if [ -n "$todos" ]; then
            echo "âš ï¸ Found TODO items:"
            echo "$todos"
          else
            echo "âœ… No TODO items found"
          fi

  terraform-plan:
    name: Terraform Plan (Metastore)
    runs-on: ubuntu-latest
    needs: [validate-terraform]
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Terraform Init
        run: |
          cd terraform/metastore
          terraform init

      - name: Terraform Plan
        id: plan
        run: |
          cd terraform/metastore
          terraform plan -out=tfplan -no-color
        continue-on-error: true
        env:
          ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
          DATABRICKS_ACCOUNT_ID: ${{ secrets.DATABRICKS_ACCOUNT_ID }}

      - name: Comment PR with Plan
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const output = `#### Terraform Plan ðŸ“
            
            \`\`\`
            ${{ steps.plan.outputs.stdout }}
            \`\`\`
            
            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`, Workflow: \`${{ github.workflow }}\`*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

  validation-summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-bicep, validate-terraform, security-scan, documentation-check]
    if: always()
    
    steps:
      - name: Check All Jobs Status
        run: |
          echo "## Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Bicep Validation | ${{ needs.validate-bicep.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform Validation | ${{ needs.validate-terraform.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Documentation Check | ${{ needs.documentation-check.result }} |" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.validate-bicep.result }}" == "failure" ]] || \
             [[ "${{ needs.validate-terraform.result }}" == "failure" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ **Validation failed. Please review the errors above.**" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **All validations passed successfully!**" >> $GITHUB_STEP_SUMMARY
          fi
