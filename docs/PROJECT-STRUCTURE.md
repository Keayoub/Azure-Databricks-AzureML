# Project Structure & Documentation Map

**Complete guide to navigating your enhanced Azure Databricks + Azure ML project**

---

## ğŸ“ Project Root Files

```
â”œâ”€â”€ azure.yaml                    â† AZD configuration with hooks
â”œâ”€â”€ azure.yaml                    â† Project manifest
â”œâ”€â”€ deploy.bat / deploy.sh        â† Deployment scripts
â”œâ”€â”€ README.md                     â† START HERE: Project overview
â”œâ”€â”€ QUICKSTART.md                 â† 5-minute quick start
â”‚
â”œâ”€â”€ docs/                         â† Documentation
â”‚   â”œâ”€â”€ DEPLOYMENT-PROCESS.md    â† Complete deployment guide
â”‚   â”œâ”€â”€ ENHANCEMENTS-SUMMARY.md  â† (NEW) What was improved
â”‚   â”œâ”€â”€ TERRAFORM-AZD-INTEGRATION.md
â”‚   â”œâ”€â”€ SECURITY-AUDIT.md
â”‚   â”œâ”€â”€ DATABRICKS-KEYVAULT-ARCHITECTURE-GUIDE.md  â† Key Vault options and guidance
â”‚   â””â”€â”€ design/                  â† Architecture diagrams
â”‚
â”œâ”€â”€ infra/                        â† Azure Infrastructure (Bicep)
â”‚   â”œâ”€â”€ main.bicep               â† Main orchestration file
â”‚   â”œâ”€â”€ main.bicepparam          â† Parameters (EDIT THIS)
â”‚   â”œâ”€â”€ main.bicepparam          â† Encrypted parameters
â”‚   â”‚
â”‚   â”œâ”€â”€ components/              â† Bicep modules
â”‚   â”‚   â”œâ”€â”€ networking/
â”‚   â”‚   â”œâ”€â”€ databricks/
â”‚   â”‚   â”œâ”€â”€ storage/
â”‚   â”‚   â”œâ”€â”€ keyvault/
â”‚   â”‚   â”œâ”€â”€ azureml/
â”‚   â”‚   â”œâ”€â”€ ai-foundry/
â”‚   â”‚   â””â”€â”€ ... (other components)
â”‚   â”‚
â”‚   â””â”€â”€ scripts/                 â† Deployment scripts
â”‚       â”œâ”€â”€ validate.ps1         â† (NEW) Pre-flight checks
â”‚       â”œâ”€â”€ postprovision.ps1    â† (ENHANCED) Metastore creation
â”‚       â”œâ”€â”€ postdeploy.ps1       â† (ENHANCED) UC deployment
â”‚       â””â”€â”€ ... (other scripts)
â”‚
â””â”€â”€ terraform/                   â† Databricks Config (Terraform)
    â”œâ”€â”€ TERRAFORM-README.md      â† (NEW) Start here for Terraform
    â”œâ”€â”€ INDEX.md                 â† (NEW) Quick navigation
    â”œâ”€â”€ README.md                â† Legacy docs
    â”‚
    â”œâ”€â”€ metastore/               â† Layer 1: Account-level metastore
    â”‚   â”œâ”€â”€ main.tf
    â”‚   â”œâ”€â”€ variables.tf
    â”‚   â”œâ”€â”€ outputs.tf
    â”‚   â”œâ”€â”€ providers.tf
    â”‚   â””â”€â”€ (terraform.tfvars)   â† Auto-generated by postprovision
    â”‚
    â”œâ”€â”€ environments/            â† Layer 2: Workspace UC components
    â”‚   â”œâ”€â”€ main.tf
    â”‚   â”œâ”€â”€ variables.tf
    â”‚   â”œâ”€â”€ outputs.tf
    â”‚   â”œâ”€â”€ providers.tf
    â”‚   â”œâ”€â”€ terraform.tfvars     â† Auto-generated by postdeploy
    â”‚   â””â”€â”€ tfplan               â† Built during apply
    â”‚
    â”œâ”€â”€ modules/                 â† Reusable Terraform modules
    â”‚   â”œâ”€â”€ adb-uc-catalogs/    â† Create catalogs/schemas
    â”‚   â”‚   â”œâ”€â”€ main.tf
    â”‚   â”‚   â”œâ”€â”€ variables.tf
    â”‚   â”‚   â”œâ”€â”€ outputs.tf
    â”‚   â”‚   â”œâ”€â”€ README.md
    â”‚   â”‚   â””â”€â”€ examples.tf
    â”‚   â”‚
    â”‚   â””â”€â”€ adb-uc-volumes/     â† Create external volumes
    â”‚       â”œâ”€â”€ main.tf
    â”‚       â”œâ”€â”€ variables.tf
    â”‚       â”œâ”€â”€ outputs.tf
    â”‚       â”œâ”€â”€ README.md
    â”‚       â””â”€â”€ examples.tf
    â”‚
    â””â”€â”€ docs/
        â”œâ”€â”€ TERRAFORM-QUICK-START.md
        â”œâ”€â”€ TERRAFORM-QUICK-REFERENCE.md
        â””â”€â”€ DEPLOYMENT.md
```

---

## ğŸ—‚ï¸ Getting Started: Where to Look

### ğŸ¯ "I'm new, where do I start?"

1. **[README.md](../README.md)** (5 min)
   - Project overview
   - What's deployed
   - Security features

2. **[QUICKSTART.md](../QUICKSTART.md)** (10 min)
   - Installation instructions
   - First deployment

3. **[docs/DEPLOYMENT-PROCESS.md](../docs/DEPLOYMENT-PROCESS.md)** (20 min)
   - Detailed walkthrough
   - Troubleshooting
   - Phase explanations

### ğŸ—ï¸ "I want to understand the architecture"

1. **[README.md - Two-Phase Architecture Section](../README.md#-two-phase-deployment-architecture)**
   - Overview of Bicep vs Terraform
   - Why separation is important

2. **[docs/design/Azure-Architecture.drawio](../docs/design/Azure-Architecture.drawio)**
   - Visual architecture diagrams
   - Component relationships

3. **[docs/DEPLOYMENT-PROCESS.md - Architecture Overview](../docs/DEPLOYMENT-PROCESS.md#architecture)**
   - Complete architecture explanation
   - Data flow diagrams

### âš™ï¸ "I need to deploy or change something"

**For Infrastructure (Bicep):**
1. Edit `infra/main.bicepparam`
2. Run `azd provision`

**For Databricks Config (Terraform):**
1. Edit `terraform/environments/main.tf` or `terraform/metastore/main.tf`
2. Run `terraform plan` to review
3. Run `terraform apply` to deploy

### ğŸ” "I need to find something specific"

1. **[terraform/INDEX.md](TERRAFORM-INDEX.md)** - Quick reference index
2. **[terraform/TERRAFORM-README.md](TERRAFORM-README.md)** - Terraform guide
3. **[docs/DEPLOYMENT-PROCESS.md](../docs/DEPLOYMENT-PROCESS.md)** - Complete guide

### ğŸ› "Something's broken"

1. Run validation: `pwsh infra/scripts/validate.ps1`
2. Check [DEPLOYMENT-PROCESS.md - Troubleshooting](../docs/DEPLOYMENT-PROCESS.md#troubleshooting)
3. Review [terraform/TERRAFORM-README.md - Troubleshooting](TERRAFORM-README.md#troubleshooting)

---

## ğŸ“– Documentation by Topic

### Deployment & Getting Started

| Document | Length | Purpose |
|----------|--------|---------|
| [README.md](../README.md) | 10 min | Project overview |
| [QUICKSTART.md](../QUICKSTART.md) | 5 min | Get started fast |
| [DEPLOYMENT-PROCESS.md](../docs/DEPLOYMENT-PROCESS.md) | 30 min | Detailed deployment guide |
| [ENHANCEMENTS-SUMMARY.md](ENHANCEMENTS-SUMMARY.md) | 20 min | What was improved |

### Terraform & Databricks Configuration

| Document | Length | Purpose |
|----------|--------|---------|
| [terraform/TERRAFORM-README.md](../terraform/TERRAFORM-README.md) | 20 min | Terraform overview |
| [terraform/INDEX.md](../terraform/INDEX.md) | 15 min | Quick navigation |
| [terraform/docs/TERRAFORM-QUICK-START.md](../terraform/docs/TERRAFORM-QUICK-START.md) | 10 min | Quick start |
| [terraform/docs/TERRAFORM-QUICK-REFERENCE.md](../terraform/docs/TERRAFORM-QUICK-REFERENCE.md) | 5 min | Command reference |
| [terraform/modules/adb-uc-catalogs/README.md](../terraform/modules/adb-uc-catalogs/README.md) | 10 min | Catalogs module |
| [terraform/modules/adb-uc-volumes/README.md](../terraform/modules/adb-uc-volumes/README.md) | 10 min | Volumes module |

### Azure Infrastructure & Security

| Document | Length | Purpose |
|----------|--------|---------|
| [SECURITY-AUDIT.md](SECURITY-AUDIT.md) | 15 min | Security details |
| [DATABRICKS-KEYVAULT-ARCHITECTURE-GUIDE.md](DATABRICKS-KEYVAULT-ARCHITECTURE-GUIDE.md) | 15 min | Key Vault options and guidance |
| [TERRAFORM-AZD-INTEGRATION.md](TERRAFORM-AZD-INTEGRATION.md) | 10 min | Integration guide |
| [design/Azure-Architecture.drawio](design/Azure-Architecture.drawio) | 5 min | Visual diagrams |

---

## ğŸš€ Common Workflows

### Deploy Everything From Scratch

```bash
# 1. Validate prerequisites
pwsh infra/scripts/validate.ps1

# 2. Set up Databricks Account ID (one-time)
$env:DATABRICKS_ACCOUNT_ID = "b90dde1c-048c-4a28-b7d1-6c7c4df24b90"

# 3. Deploy infrastructure + metastore
azd provision

# 4. Deploy UC catalogs
azd deploy

# âœ… Done! Check Databricks workspace
```

**See:** [QUICKSTART.md](../QUICKSTART.md)

### Update Catalogs & Schemas

```bash
# 1. Edit schemas
nano terraform/environments/main.tf

# 2. Review changes
cd terraform/environments
terraform plan -out=tfplan

# 3. Apply changes
terraform apply tfplan

# âœ… Check Databricks catalog browser
```

**See:** [terraform/TERRAFORM-README.md - Manual Updates](../terraform/TERRAFORM-README.md#manual-updates-advanced)

### Troubleshoot Deployment Errors

```bash
# 1. Run validation
pwsh infra/scripts/validate.ps1

# 2. Check detailed guide
# See: docs/DEPLOYMENT-PROCESS.md#troubleshooting

# 3. Check Terraform logs
cd terraform/metastore
cat terraform.log

# 4. Review error messages
# See: terraform/TERRAFORM-README.md#troubleshooting
```

**See:** [DEPLOYMENT-PROCESS.md#troubleshooting](../docs/DEPLOYMENT-PROCESS.md#troubleshooting)

### Create a New Catalog

```bash
# 1. Edit terraform/environments/main.tf
# 2. Add to the catalogs variable in adb-uc-catalogs module
# 3. Plan and apply

cd terraform/environments
terraform plan -out=tfplan
terraform apply tfplan
```

**See:** [terraform/modules/adb-uc-catalogs/README.md](../terraform/modules/adb-uc-catalogs/README.md)

### Destroy & Recreate Everything

```bash
# 1. Destroy Terraform resources (UC components first)
cd terraform/environments
terraform destroy

# 2. Destroy metastore
cd ../metastore
terraform destroy

# 3. Destroy Azure infrastructure
azd down

# 4. Recreate everything
azd provision && azd deploy
```

**âš ï¸ Warning:** This destroys data in external volumes. See [DEPLOYMENT-PROCESS.md](../docs/DEPLOYMENT-PROCESS.md) before doing this.

---

## ğŸ“ Understanding the Two-Phase Architecture

### Phase 1: Infrastructure (Bicep)

**What it does:** Deploys Azure cloud resources

**Tools:**
- ğŸ› ï¸ Bicep IaC language
- ğŸ“ Configuration: `infra/main.bicepparam`
- ğŸƒ Executed by: `azd provision`

**Creates:**
- Virtual Networks and Security Groups
- Storage Accounts (ADLS Gen2)
- Databricks Workspace (Premium, VNet-injected)
- Azure ML, AI Foundry
- Key Vault, Container Registry
- Private Endpoints

**Outputs:**
- Workspace URL, Region, Resource Groups, Storage Account Info

### Phase 1.5: Metastore (Terraform)

**What it does:** Creates Databricks account-level metastore

**Tools:**
- ğŸ› ï¸ Terraform + Databricks provider (account-level)
- ğŸ“ Configuration: `terraform/metastore/`
- ğŸƒ Executed by: `infra/scripts/postprovision.ps1` (during azd provision)

**Creates:**
- Unity Catalog Metastore
- Workspace-to-Metastore Assignment
- Default Namespace Setting

**Requires:**
- DATABRICKS_ACCOUNT_ID environment variable
- Bicep outputs (workspace ID, host, region)

### Phase 2: Configuration (Terraform)

**What it does:** Creates Databricks workspace-level configuration

**Tools:**
- ğŸ› ï¸ Terraform + Databricks provider (workspace-level)
- ğŸ“ Configuration: `terraform/environments/`
- ğŸƒ Executed by: `azd deploy` â†’ `infra/scripts/postdeploy.ps1`

**Creates:**
- Catalogs (dev, qa, prod)
- Schemas (bronze, silver, gold)
- External Volumes
- Storage Credentials

**Requires:**
- Metastore already created (Phase 1.5)
- Bicep outputs (workspace URL, region)

### Why Separate?

| Aspect | Phase 1 (Bicep) | Phase 1.5 (Metastore) | Phase 2 (UC) |
|--------|-----------------|----------------------|--------------|
| Owner | Cloud Admin | Account Admin | Databricks Admin |
| Tool | Bicep | Terraform | Terraform |
| Scope | Azure Resources | Account-level | Workspace-level |
| Frequency | Rare changes | One-time setup | Frequent changes |
| Team | Cloud Ops | Cloud Ops | Data Ops |

**Result:** Teams own their layer, clear boundaries, no conflicts.

---

## ğŸ“š Quick Reference

### Environment Variables

```bash
# Required for deployment
$env:DATABRICKS_ACCOUNT_ID = "your-account-id"  # From accounts.azuredatabricks.net

# Optional
$env:AZURE_ENV_NAME = "dev"                    # Or "staging", "prod"
$env:PROJECT_NAME = "dbxaml"                   # Project identifier
```

### Important Files to Edit

| File | Purpose | When to Edit |
|------|---------|--------------|
| `infra/main.bicepparam` | Azure resource parameters | Changing Azure resources |
| `terraform/environments/main.tf` | Catalogs and schemas | Changing Databricks schemas |
| `terraform/metastore/main.tf` | Metastore configuration | Metastore changes (rare) |

### Commands Reference

```bash
# Validate setup
pwsh infra/scripts/validate.ps1

# Full deployment
azd provision          # Infrastructure + Metastore
azd deploy            # UC components

# Terraform manual
cd terraform/environments
terraform init
terraform plan -out=tfplan
terraform apply tfplan

# Cleanup
azd down              # Remove Azure resources
terraform destroy     # Remove Databricks resources
```

---

## ğŸ†˜ Need Help?

### For...

**"I'm stuck on deployment"**
â†’ [DEPLOYMENT-PROCESS.md#troubleshooting](../docs/DEPLOYMENT-PROCESS.md#troubleshooting)

**"How do I deploy?"**
â†’ [QUICKSTART.md](../QUICKSTART.md)

**"Terraform isn't working"**
â†’ [terraform/TERRAFORM-README.md#troubleshooting](../terraform/TERRAFORM-README.md#troubleshooting)

**"Where do I find X?"**
â†’ [terraform/INDEX.md](../terraform/INDEX.md)

**"What resources get created?"**
â†’ [README.md#-what-gets-deployed](../README.md#-what-gets-deployed)

**"How is it secured?"**
â†’ [README.md#-security-features](../README.md#-security-features)

**"What changed from before?"**
â†’ [ENHANCEMENTS-SUMMARY.md](ENHANCEMENTS-SUMMARY.md)

---

## ğŸ“ Support Resources

1. **Run validation:** `pwsh infra/scripts/validate.ps1` - Catches configuration issues
2. **Read guides:** Review [DEPLOYMENT-PROCESS.md](../docs/DEPLOYMENT-PROCESS.md) for step-by-step help
3. **Check quick ref:** Look at [terraform/INDEX.md](../terraform/INDEX.md) for quick lookups
4. **Review logs:** Check `terraform.log` for detailed error messages
5. **Explore examples:** See `terraform/modules/*/examples.tf` for usage

---

**Last Updated:** [Current Session]
**Status:** Production-Ready âœ…
