#!/usr/bin/env pwsh

Write-Host "========================================================" -ForegroundColor Green
Write-Host "Post-Deploy: Deploying Unity Catalog Components" -ForegroundColor Green
Write-Host "========================================================" -ForegroundColor Green
Write-Host ""
Write-Host "Phase 2: Deploy UC Catalogs, Schemas, and Volumes" -ForegroundColor Cyan
Write-Host ""

# This script runs AFTER metastore creation (postprovision)
# It deploys Unity Catalog components: catalogs, schemas, tables, volumes

# Get outputs from Bicep deployment
Write-Host "Retrieving Bicep deployment outputs..." -ForegroundColor Cyan

$SUBSCRIPTION_ID = $(az account show --query id -o tsv)
Write-Host "  ✓ Subscription ID: $SUBSCRIPTION_ID" -ForegroundColor Green

# Get workspace info from azd environment variables (set by Bicep outputs)
$DATABRICKS_RESOURCE_GROUP = $env:databricksResourceGroupName
$WORKSPACE_URL = $env:databricksWorkspaceUrl

if (-not $DATABRICKS_RESOURCE_GROUP -or -not $WORKSPACE_URL) {
  Write-Host "ERROR: Missing Bicep environment variables" -ForegroundColor Red
  Write-Host "  DATABRICKS_RESOURCE_GROUP: $DATABRICKS_RESOURCE_GROUP" -ForegroundColor Red
  Write-Host "  WORKSPACE_URL: $WORKSPACE_URL" -ForegroundColor Red
  exit 1
}

# Extract workspace host
$DATABRICKS_WORKSPACE_HOST = "https://$WORKSPACE_URL"
Write-Host "  ✓ Workspace Host: $DATABRICKS_WORKSPACE_HOST" -ForegroundColor Green

# Get workspace region
$WORKSPACE_DETAILS = $(az databricks workspace list `
  --resource-group $DATABRICKS_RESOURCE_GROUP `
  --query "[0]" -o json | ConvertFrom-Json)

$WORKSPACE_REGION = $WORKSPACE_DETAILS.location
Write-Host "  ✓ Region: $WORKSPACE_REGION" -ForegroundColor Green

# Get environment name from the bicep parameter file
$BICEP_PARAMS_FILE = Join-Path $PSScriptRoot "..\main.bicepparam"
if (Test-Path $BICEP_PARAMS_FILE) {
  $BICEP_PARAMS = Get-Content $BICEP_PARAMS_FILE -Raw
  # Extract environmentName = 'dev' or "dev"
  if ($BICEP_PARAMS -match "param environmentName = '(\w+)'") {
    $ENV_NAME = $Matches[1]
    Write-Host "  ✓ Environment Name (from bicep): $ENV_NAME" -ForegroundColor Green
  } elseif ($BICEP_PARAMS -match 'param environmentName = "(\w+)"') {
    $ENV_NAME = $Matches[1]
    Write-Host "  ✓ Environment Name (from bicep): $ENV_NAME" -ForegroundColor Green
  } else {
    # Fallback: extract from AZURE_ENV_NAME
    $ENV_NAME = $env:AZURE_ENV_NAME -replace "databricks-azureml-", ""
    Write-Host "  ✓ Environment Name (from AZURE_ENV_NAME): $ENV_NAME" -ForegroundColor Yellow
  }
} else {
  # Fallback if no bicep params file
  $ENV_NAME = $env:AZURE_ENV_NAME -replace "databricks-azureml-", ""
  Write-Host "  ✓ Environment Name (from AZURE_ENV_NAME): $ENV_NAME" -ForegroundColor Yellow
}

Write-Host ""

# Navigate to terraform environments directory
Write-Host "Initializing Terraform for UC Components..." -ForegroundColor Cyan

# Get the project root (2 levels up from this script: scripts -> infra -> root)
$PROJECT_ROOT = Split-Path -Parent (Split-Path -Parent $PSScriptRoot)
$TERRAFORM_DIR = Join-Path $PROJECT_ROOT "terraform" "environments"

Write-Host "  Project Root: $PROJECT_ROOT" -ForegroundColor Green
Write-Host "  Terraform Dir: $TERRAFORM_DIR" -ForegroundColor Green

if (-not (Test-Path $TERRAFORM_DIR)) {
  Write-Host "ERROR: Terraform environments directory not found: $TERRAFORM_DIR" -ForegroundColor Red
  exit 1
}

Push-Location $TERRAFORM_DIR

# Create terraform.tfvars for UC components
Write-Host "Creating UC components terraform.tfvars..."

$tfvars = @"
# Auto-generated by azd postdeploy
azure_region                = "$WORKSPACE_REGION"
environment_name            = "$ENV_NAME"
databricks_workspace_host   = "$DATABRICKS_WORKSPACE_HOST"
"@

Set-Content -Path "terraform.tfvars" -Value $tfvars
Write-Host "  ✓ Created terraform.tfvars" -ForegroundColor Green

Write-Host ""
Write-Host "Cleaning Terraform cache..." -ForegroundColor Cyan
Remove-Item -Path ".terraform" -Recurse -Force -ErrorAction SilentlyContinue
Remove-Item -Path ".terraform.lock.hcl" -Force -ErrorAction SilentlyContinue
Remove-Item -Path "tfplan" -Force -ErrorAction SilentlyContinue

Write-Host ""
Write-Host "Running: terraform init..." -ForegroundColor Cyan
terraform init -upgrade

if ($LASTEXITCODE -ne 0) {
  Write-Host "ERROR: terraform init failed" -ForegroundColor Red
  Pop-Location
  exit 1
}
Write-Host "  ✓ Terraform initialized" -ForegroundColor Green

Write-Host ""
Write-Host "Running: terraform validate..." -ForegroundColor Cyan
terraform validate

if ($LASTEXITCODE -ne 0) {
  Write-Host "ERROR: terraform validate failed" -ForegroundColor Red
  Pop-Location
  exit 1
}
Write-Host "  ✓ Terraform configuration valid" -ForegroundColor Green

Write-Host ""
Write-Host "Running: terraform plan..." -ForegroundColor Cyan
terraform plan -out=tfplan

if ($LASTEXITCODE -ne 0) {
  Write-Host "ERROR: terraform plan failed" -ForegroundColor Red
  Pop-Location
  exit 1
}
Write-Host "  ✓ Plan created and saved to tfplan" -ForegroundColor Green

Write-Host ""
Write-Host "========================================================" -ForegroundColor Cyan
Write-Host "Change Summary:" -ForegroundColor Cyan
Write-Host "========================================================" -ForegroundColor Cyan
Write-Host "Terraform will create/modify resources as shown above." -ForegroundColor Yellow
Write-Host "Review the plan to ensure resources are correct." -ForegroundColor Yellow
Write-Host ""
Write-Host "  WORKSPACE HOST  : $DATABRICKS_WORKSPACE_HOST" -ForegroundColor Cyan
Write-Host "  REGION          : $WORKSPACE_REGION" -ForegroundColor Cyan
Write-Host "  ENVIRONMENT     : $ENV_NAME" -ForegroundColor Cyan
Write-Host ""
Write-Host "Press Enter to apply or Ctrl+C to cancel..."
Read-Host

Write-Host ""
Write-Host "Running: terraform apply..." -ForegroundColor Cyan
terraform apply -auto-approve tfplan

if ($LASTEXITCODE -ne 0) {
  Write-Host ""
  Write-Host "========================================================" -ForegroundColor Red
  Write-Host "✗ UC components deployment failed!" -ForegroundColor Red
  Write-Host "========================================================" -ForegroundColor Red
  Write-Host ""
  Write-Host "Troubleshooting:" -ForegroundColor Yellow
  Write-Host "  1. Check tfplan for errors" -ForegroundColor Yellow
  Write-Host "  2. Verify Databricks workspace is accessible" -ForegroundColor Yellow
  Write-Host "  3. Check Databricks account and metastore settings" -ForegroundColor Yellow
  Write-Host "  4. Review logs: cat terraform.log" -ForegroundColor Yellow
  Write-Host ""
  Pop-Location
  exit 1
}

Write-Host ""
Write-Host "========================================================" -ForegroundColor Green
Write-Host "✓ UC components deployment completed successfully!" -ForegroundColor Green
Write-Host "========================================================" -ForegroundColor Green
Write-Host ""
Write-Host "Next Steps:" -ForegroundColor Cyan
Write-Host "  1. Visit Databricks workspace: $DATABRICKS_WORKSPACE_HOST" -ForegroundColor Cyan
Write-Host "  2. Check Catalog browser for new catalogs and schemas" -ForegroundColor Cyan
Write-Host "  3. Review DEPLOYMENT-PROCESS.md for verification steps" -ForegroundColor Cyan
Write-Host ""

Pop-Location

Write-Host "Returning to project root: $PROJECT_ROOT" -ForegroundColor Green
