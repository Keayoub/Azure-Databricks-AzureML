{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.40.2.10011",
      "templateHash": "11914463477261810373"
    }
  },
  "parameters": {
    "environmentName": {
      "type": "string",
      "defaultValue": "dev",
      "allowedValues": [
        "dev",
        "staging",
        "prod"
      ],
      "metadata": {
        "description": "Environment name (dev, staging, prod)"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[deployment().location]",
      "metadata": {
        "description": "Primary Azure region for resources"
      }
    },
    "projectName": {
      "type": "string",
      "minLength": 3,
      "maxLength": 10,
      "metadata": {
        "description": "Project name prefix for resource naming"
      }
    },
    "enableUnityCatalog": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable Unity Catalog for Databricks"
      }
    },
    "deployAzureML": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Deploy Azure ML workspace"
      }
    },
    "deployAIFoundry": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Deploy AI Foundry hub"
      }
    },
    "deployAKS": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Deploy AKS cluster for Azure ML model serving"
      }
    },
    "aksNodeCount": {
      "type": "int",
      "defaultValue": 3,
      "minValue": 1,
      "maxValue": 10,
      "metadata": {
        "description": "AKS node count for model serving"
      }
    },
    "adminObjectId": {
      "type": "string",
      "metadata": {
        "description": "Your object ID for admin permissions"
      }
    },
    "tags": {
      "type": "object",
      "defaultValue": {
        "Environment": "[parameters('environmentName')]",
        "Project": "[parameters('projectName')]",
        "ManagedBy": "Bicep",
        "Purpose": "SecureDataPlatform"
      },
      "metadata": {
        "description": "Tags for all resources"
      }
    }
  },
  "variables": {
    "uniqueSuffix": "[uniqueString(subscription().id, parameters('projectName'), parameters('location'))]",
    "resourceGroupName": "[format('rg-{0}-{1}-{2}', parameters('projectName'), parameters('environmentName'), variables('uniqueSuffix'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2024-03-01",
      "name": "[variables('resourceGroupName')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]"
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "networking-deployment",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "projectName": {
            "value": "[parameters('projectName')]"
          },
          "environmentName": {
            "value": "[parameters('environmentName')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "deployAKS": {
            "value": "[parameters('deployAKS')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "12010763747470390602"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "projectName": {
              "type": "string"
            },
            "environmentName": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "deployAKS": {
              "type": "bool"
            }
          },
          "variables": {
            "vnetName": "[format('vnet-{0}-{1}', parameters('projectName'), parameters('environmentName'))]",
            "vnetAddressPrefix": "10.0.0.0/16",
            "databricksPublicSubnetName": "snet-databricks-public",
            "databricksPublicSubnetPrefix": "10.0.1.0/24",
            "databricksPrivateSubnetName": "snet-databricks-private",
            "databricksPrivateSubnetPrefix": "10.0.2.0/24",
            "azureMLComputeSubnetName": "snet-azureml-compute",
            "azureMLComputeSubnetPrefix": "10.0.3.0/24",
            "aksSubnetName": "snet-aks",
            "aksSubnetPrefix": "10.0.4.0/23",
            "privateEndpointSubnetName": "snet-private-endpoints",
            "privateEndpointSubnetPrefix": "10.0.6.0/24"
          },
          "resources": [
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2024-01-01",
              "name": "[format('nsg-{0}', variables('databricksPublicSubnetName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "AllowDatabricksControlPlane",
                    "properties": {
                      "priority": 100,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourceAddressPrefix": "AzureDatabricks",
                      "sourcePortRange": "*",
                      "destinationAddressPrefix": "*",
                      "destinationPortRange": "*"
                    }
                  },
                  {
                    "name": "AllowVnetInbound",
                    "properties": {
                      "priority": 110,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "*",
                      "sourceAddressPrefix": "VirtualNetwork",
                      "sourcePortRange": "*",
                      "destinationAddressPrefix": "VirtualNetwork",
                      "destinationPortRange": "*"
                    }
                  },
                  {
                    "name": "DenyAllInbound",
                    "properties": {
                      "priority": 4096,
                      "direction": "Inbound",
                      "access": "Deny",
                      "protocol": "*",
                      "sourceAddressPrefix": "*",
                      "sourcePortRange": "*",
                      "destinationAddressPrefix": "*",
                      "destinationPortRange": "*"
                    }
                  },
                  {
                    "name": "AllowDatabricksOutbound",
                    "properties": {
                      "priority": 100,
                      "direction": "Outbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourceAddressPrefix": "*",
                      "sourcePortRange": "*",
                      "destinationAddressPrefix": "AzureDatabricks",
                      "destinationPortRange": "*"
                    }
                  },
                  {
                    "name": "AllowSqlOutbound",
                    "properties": {
                      "priority": 110,
                      "direction": "Outbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourceAddressPrefix": "*",
                      "sourcePortRange": "*",
                      "destinationAddressPrefix": "Sql",
                      "destinationPortRange": "3306"
                    }
                  },
                  {
                    "name": "AllowStorageOutbound",
                    "properties": {
                      "priority": 120,
                      "direction": "Outbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourceAddressPrefix": "*",
                      "sourcePortRange": "*",
                      "destinationAddressPrefix": "Storage",
                      "destinationPortRange": "443"
                    }
                  },
                  {
                    "name": "AllowVnetOutbound",
                    "properties": {
                      "priority": 130,
                      "direction": "Outbound",
                      "access": "Allow",
                      "protocol": "*",
                      "sourceAddressPrefix": "VirtualNetwork",
                      "sourcePortRange": "*",
                      "destinationAddressPrefix": "VirtualNetwork",
                      "destinationPortRange": "*"
                    }
                  },
                  {
                    "name": "AllowEventHubOutbound",
                    "properties": {
                      "priority": 140,
                      "direction": "Outbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourceAddressPrefix": "*",
                      "sourcePortRange": "*",
                      "destinationAddressPrefix": "EventHub",
                      "destinationPortRange": "9093"
                    }
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2024-01-01",
              "name": "[format('nsg-{0}', variables('databricksPrivateSubnetName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "AllowDatabricksControlPlane",
                    "properties": {
                      "priority": 100,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourceAddressPrefix": "AzureDatabricks",
                      "sourcePortRange": "*",
                      "destinationAddressPrefix": "*",
                      "destinationPortRange": "*"
                    }
                  },
                  {
                    "name": "AllowVnetInbound",
                    "properties": {
                      "priority": 110,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "*",
                      "sourceAddressPrefix": "VirtualNetwork",
                      "sourcePortRange": "*",
                      "destinationAddressPrefix": "VirtualNetwork",
                      "destinationPortRange": "*"
                    }
                  },
                  {
                    "name": "DenyAllInbound",
                    "properties": {
                      "priority": 4096,
                      "direction": "Inbound",
                      "access": "Deny",
                      "protocol": "*",
                      "sourceAddressPrefix": "*",
                      "sourcePortRange": "*",
                      "destinationAddressPrefix": "*",
                      "destinationPortRange": "*"
                    }
                  },
                  {
                    "name": "AllowDatabricksOutbound",
                    "properties": {
                      "priority": 100,
                      "direction": "Outbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourceAddressPrefix": "*",
                      "sourcePortRange": "*",
                      "destinationAddressPrefix": "AzureDatabricks",
                      "destinationPortRange": "*"
                    }
                  },
                  {
                    "name": "AllowSqlOutbound",
                    "properties": {
                      "priority": 110,
                      "direction": "Outbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourceAddressPrefix": "*",
                      "sourcePortRange": "*",
                      "destinationAddressPrefix": "Sql",
                      "destinationPortRange": "3306"
                    }
                  },
                  {
                    "name": "AllowStorageOutbound",
                    "properties": {
                      "priority": 120,
                      "direction": "Outbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourceAddressPrefix": "*",
                      "sourcePortRange": "*",
                      "destinationAddressPrefix": "Storage",
                      "destinationPortRange": "443"
                    }
                  },
                  {
                    "name": "AllowVnetOutbound",
                    "properties": {
                      "priority": 130,
                      "direction": "Outbound",
                      "access": "Allow",
                      "protocol": "*",
                      "sourceAddressPrefix": "VirtualNetwork",
                      "sourcePortRange": "*",
                      "destinationAddressPrefix": "VirtualNetwork",
                      "destinationPortRange": "*"
                    }
                  },
                  {
                    "name": "AllowEventHubOutbound",
                    "properties": {
                      "priority": 140,
                      "direction": "Outbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourceAddressPrefix": "*",
                      "sourcePortRange": "*",
                      "destinationAddressPrefix": "EventHub",
                      "destinationPortRange": "9093"
                    }
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2024-01-01",
              "name": "[format('nsg-{0}', variables('azureMLComputeSubnetName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "AllowBatchNodeManagement",
                    "properties": {
                      "priority": 100,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourceAddressPrefix": "BatchNodeManagement",
                      "sourcePortRange": "*",
                      "destinationAddressPrefix": "*",
                      "destinationPortRange": "29876-29877"
                    }
                  },
                  {
                    "name": "AllowAzureMachineLearning",
                    "properties": {
                      "priority": 110,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourceAddressPrefix": "AzureMachineLearning",
                      "sourcePortRange": "*",
                      "destinationAddressPrefix": "*",
                      "destinationPortRange": "44224"
                    }
                  },
                  {
                    "name": "AllowVnetInbound",
                    "properties": {
                      "priority": 120,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "*",
                      "sourceAddressPrefix": "VirtualNetwork",
                      "sourcePortRange": "*",
                      "destinationAddressPrefix": "VirtualNetwork",
                      "destinationPortRange": "*"
                    }
                  }
                ]
              }
            },
            {
              "condition": "[parameters('deployAKS')]",
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2024-01-01",
              "name": "[format('nsg-{0}', variables('aksSubnetName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "AllowVnetInbound",
                    "properties": {
                      "priority": 100,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "*",
                      "sourceAddressPrefix": "VirtualNetwork",
                      "sourcePortRange": "*",
                      "destinationAddressPrefix": "VirtualNetwork",
                      "destinationPortRange": "*"
                    }
                  },
                  {
                    "name": "AllowAzureLoadBalancer",
                    "properties": {
                      "priority": 110,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "*",
                      "sourceAddressPrefix": "AzureLoadBalancer",
                      "sourcePortRange": "*",
                      "destinationAddressPrefix": "*",
                      "destinationPortRange": "*"
                    }
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2024-01-01",
              "name": "[format('nsg-{0}', variables('privateEndpointSubnetName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "AllowVnetInbound",
                    "properties": {
                      "priority": 100,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "*",
                      "sourceAddressPrefix": "VirtualNetwork",
                      "sourcePortRange": "*",
                      "destinationAddressPrefix": "VirtualNetwork",
                      "destinationPortRange": "*"
                    }
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2024-01-01",
              "name": "[variables('vnetName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": [
                    "[variables('vnetAddressPrefix')]"
                  ]
                },
                "subnets": [
                  {
                    "name": "[variables('databricksPublicSubnetName')]",
                    "properties": {
                      "addressPrefix": "[variables('databricksPublicSubnetPrefix')]",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', format('nsg-{0}', variables('databricksPublicSubnetName')))]"
                      },
                      "delegations": [
                        {
                          "name": "databricks-delegation-public",
                          "properties": {
                            "serviceName": "Microsoft.Databricks/workspaces"
                          }
                        }
                      ],
                      "serviceEndpoints": [
                        {
                          "service": "Microsoft.Storage"
                        },
                        {
                          "service": "Microsoft.KeyVault"
                        }
                      ]
                    }
                  },
                  {
                    "name": "[variables('databricksPrivateSubnetName')]",
                    "properties": {
                      "addressPrefix": "[variables('databricksPrivateSubnetPrefix')]",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', format('nsg-{0}', variables('databricksPrivateSubnetName')))]"
                      },
                      "delegations": [
                        {
                          "name": "databricks-delegation-private",
                          "properties": {
                            "serviceName": "Microsoft.Databricks/workspaces"
                          }
                        }
                      ],
                      "serviceEndpoints": [
                        {
                          "service": "Microsoft.Storage"
                        },
                        {
                          "service": "Microsoft.KeyVault"
                        }
                      ]
                    }
                  },
                  {
                    "name": "[variables('azureMLComputeSubnetName')]",
                    "properties": {
                      "addressPrefix": "[variables('azureMLComputeSubnetPrefix')]",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', format('nsg-{0}', variables('azureMLComputeSubnetName')))]"
                      },
                      "serviceEndpoints": [
                        {
                          "service": "Microsoft.Storage"
                        },
                        {
                          "service": "Microsoft.KeyVault"
                        },
                        {
                          "service": "Microsoft.ContainerRegistry"
                        }
                      ]
                    }
                  },
                  {
                    "name": "[variables('aksSubnetName')]",
                    "properties": {
                      "addressPrefix": "[variables('aksSubnetPrefix')]",
                      "networkSecurityGroup": "[if(parameters('deployAKS'), createObject('id', resourceId('Microsoft.Network/networkSecurityGroups', format('nsg-{0}', variables('aksSubnetName')))), null())]",
                      "serviceEndpoints": [
                        {
                          "service": "Microsoft.Storage"
                        },
                        {
                          "service": "Microsoft.ContainerRegistry"
                        }
                      ]
                    }
                  },
                  {
                    "name": "[variables('privateEndpointSubnetName')]",
                    "properties": {
                      "addressPrefix": "[variables('privateEndpointSubnetPrefix')]",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', format('nsg-{0}', variables('privateEndpointSubnetName')))]"
                      },
                      "privateEndpointNetworkPolicies": "Disabled",
                      "privateLinkServiceNetworkPolicies": "Enabled"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', format('nsg-{0}', variables('aksSubnetName')))]",
                "[resourceId('Microsoft.Network/networkSecurityGroups', format('nsg-{0}', variables('azureMLComputeSubnetName')))]",
                "[resourceId('Microsoft.Network/networkSecurityGroups', format('nsg-{0}', variables('databricksPrivateSubnetName')))]",
                "[resourceId('Microsoft.Network/networkSecurityGroups', format('nsg-{0}', variables('databricksPublicSubnetName')))]",
                "[resourceId('Microsoft.Network/networkSecurityGroups', format('nsg-{0}', variables('privateEndpointSubnetName')))]"
              ]
            }
          ],
          "outputs": {
            "vnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]"
            },
            "vnetName": {
              "type": "string",
              "value": "[variables('vnetName')]"
            },
            "databricksPublicSubnetName": {
              "type": "string",
              "value": "[variables('databricksPublicSubnetName')]"
            },
            "databricksPrivateSubnetName": {
              "type": "string",
              "value": "[variables('databricksPrivateSubnetName')]"
            },
            "azureMLComputeSubnetId": {
              "type": "string",
              "value": "[format('{0}/subnets/{1}', resourceId('Microsoft.Network/virtualNetworks', variables('vnetName')), variables('azureMLComputeSubnetName'))]"
            },
            "aksSubnetId": {
              "type": "string",
              "value": "[format('{0}/subnets/{1}', resourceId('Microsoft.Network/virtualNetworks', variables('vnetName')), variables('aksSubnetName'))]"
            },
            "privateEndpointSubnetId": {
              "type": "string",
              "value": "[format('{0}/subnets/{1}', resourceId('Microsoft.Network/virtualNetworks', variables('vnetName')), variables('privateEndpointSubnetName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "databricks-deployment",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "projectName": {
            "value": "[parameters('projectName')]"
          },
          "environmentName": {
            "value": "[parameters('environmentName')]"
          },
          "vnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'networking-deployment'), '2025-04-01').outputs.vnetId.value]"
          },
          "privateSubnetName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'networking-deployment'), '2025-04-01').outputs.databricksPrivateSubnetName.value]"
          },
          "publicSubnetName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'networking-deployment'), '2025-04-01').outputs.databricksPublicSubnetName.value]"
          },
          "privateEndpointSubnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'networking-deployment'), '2025-04-01').outputs.privateEndpointSubnetId.value]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "16390750252969170584"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "projectName": {
              "type": "string"
            },
            "environmentName": {
              "type": "string"
            },
            "vnetId": {
              "type": "string"
            },
            "privateSubnetName": {
              "type": "string"
            },
            "publicSubnetName": {
              "type": "string"
            },
            "privateEndpointSubnetId": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            }
          },
          "variables": {
            "workspaceName": "[format('dbw-{0}-{1}', parameters('projectName'), parameters('environmentName'))]",
            "managedResourceGroupName": "[format('rg-{0}-databricks-managed-{1}', parameters('projectName'), parameters('environmentName'))]",
            "pricingTier": "premium"
          },
          "resources": [
            {
              "type": "Microsoft.Databricks/workspaces",
              "apiVersion": "2024-05-01",
              "name": "[variables('workspaceName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[variables('pricingTier')]"
              },
              "properties": {
                "managedResourceGroupId": "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('managedResourceGroupName'))]",
                "parameters": {
                  "customVirtualNetworkId": {
                    "value": "[parameters('vnetId')]"
                  },
                  "customPublicSubnetName": {
                    "value": "[parameters('publicSubnetName')]"
                  },
                  "customPrivateSubnetName": {
                    "value": "[parameters('privateSubnetName')]"
                  },
                  "enableNoPublicIp": {
                    "value": true
                  },
                  "storageAccountSkuName": {
                    "value": "Standard_GRS"
                  },
                  "requireInfrastructureEncryption": {
                    "value": true
                  }
                },
                "publicNetworkAccess": "Disabled",
                "requiredNsgRules": "NoAzureDatabricksRules"
              }
            },
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2024-06-01",
              "name": "privatelink.azuredatabricks.net",
              "location": "global",
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2024-06-01",
              "name": "[format('{0}/{1}', 'privatelink.azuredatabricks.net', format('{0}-ui-link', variables('workspaceName')))]",
              "location": "global",
              "properties": {
                "registrationEnabled": false,
                "virtualNetwork": {
                  "id": "[parameters('vnetId')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.azuredatabricks.net')]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-11-01",
              "name": "[format('pe-{0}-ui', variables('workspaceName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('privateEndpointSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "databricks-ui-connection",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.Databricks/workspaces', variables('workspaceName'))]",
                      "groupIds": [
                        "databricks_ui_api"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Databricks/workspaces', variables('workspaceName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2023-11-01",
              "name": "[format('{0}/{1}', format('pe-{0}-ui', variables('workspaceName')), 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "databricks-ui-config",
                    "properties": {
                      "privateDnsZoneId": "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.azuredatabricks.net')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.azuredatabricks.net')]",
                "[resourceId('Microsoft.Network/privateEndpoints', format('pe-{0}-ui', variables('workspaceName')))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-11-01",
              "name": "[format('pe-{0}-auth', variables('workspaceName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('privateEndpointSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "databricks-auth-connection",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.Databricks/workspaces', variables('workspaceName'))]",
                      "groupIds": [
                        "browser_authentication"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Databricks/workspaces', variables('workspaceName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2023-11-01",
              "name": "[format('{0}/{1}', format('pe-{0}-auth', variables('workspaceName')), 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "databricks-auth-config",
                    "properties": {
                      "privateDnsZoneId": "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.azuredatabricks.net')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', format('pe-{0}-auth', variables('workspaceName')))]",
                "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.azuredatabricks.net')]"
              ]
            }
          ],
          "outputs": {
            "workspaceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Databricks/workspaces', variables('workspaceName'))]"
            },
            "workspaceName": {
              "type": "string",
              "value": "[variables('workspaceName')]"
            },
            "workspaceUrl": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Databricks/workspaces', variables('workspaceName')), '2024-05-01').workspaceUrl]"
            },
            "managedResourceGroupId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Databricks/workspaces', variables('workspaceName')), '2024-05-01').managedResourceGroupId]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'networking-deployment')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "storage-deployment",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "projectName": {
            "value": "[parameters('projectName')]"
          },
          "environmentName": {
            "value": "[parameters('environmentName')]"
          },
          "vnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'networking-deployment'), '2025-04-01').outputs.vnetId.value]"
          },
          "privateEndpointSubnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'networking-deployment'), '2025-04-01').outputs.privateEndpointSubnetId.value]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "712344621859995946"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "projectName": {
              "type": "string"
            },
            "environmentName": {
              "type": "string"
            },
            "vnetId": {
              "type": "string"
            },
            "privateEndpointSubnetId": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            }
          },
          "variables": {
            "storageAccountName": "[format('st{0}{1}{2}', replace(parameters('projectName'), '-', ''), parameters('environmentName'), uniqueString(resourceGroup().id))]",
            "blobPrivateEndpointName": "[format('pe-{0}-blob', variables('storageAccountName'))]",
            "dfsPrivateEndpointName": "[format('pe-{0}-dfs', variables('storageAccountName'))]",
            "filePrivateEndpointName": "[format('pe-{0}-file', variables('storageAccountName'))]",
            "mlStorageAccountName": "[format('stml{0}{1}{2}', replace(parameters('projectName'), '-', ''), parameters('environmentName'), uniqueString(resourceGroup().id))]",
            "mlBlobPrivateEndpointName": "[format('pe-{0}-blob', variables('mlStorageAccountName'))]",
            "mlFilePrivateEndpointName": "[format('pe-{0}-file', variables('mlStorageAccountName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-05-01",
              "name": "[take(variables('storageAccountName'), 24)]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Standard_RAGRS"
              },
              "kind": "StorageV2",
              "properties": {
                "accessTier": "Hot",
                "minimumTlsVersion": "TLS1_2",
                "supportsHttpsTrafficOnly": true,
                "allowBlobPublicAccess": false,
                "allowSharedKeyAccess": true,
                "networkAcls": {
                  "defaultAction": "Deny",
                  "bypass": "AzureServices, Logging",
                  "virtualNetworkRules": [],
                  "ipRules": []
                },
                "encryption": {
                  "requireInfrastructureEncryption": true,
                  "keySource": "Microsoft.Storage",
                  "services": {
                    "blob": {
                      "enabled": true,
                      "keyType": "Account"
                    },
                    "file": {
                      "enabled": true,
                      "keyType": "Account"
                    },
                    "table": {
                      "enabled": true,
                      "keyType": "Account"
                    },
                    "queue": {
                      "enabled": true,
                      "keyType": "Account"
                    }
                  }
                },
                "isHnsEnabled": true,
                "isNfsV3Enabled": false,
                "isSftpEnabled": false,
                "publicNetworkAccess": "Disabled"
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-05-01",
              "name": "[take(variables('mlStorageAccountName'), 24)]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Standard_LRS"
              },
              "kind": "StorageV2",
              "properties": {
                "accessTier": "Hot",
                "minimumTlsVersion": "TLS1_2",
                "supportsHttpsTrafficOnly": true,
                "allowBlobPublicAccess": false,
                "allowSharedKeyAccess": true,
                "networkAcls": {
                  "defaultAction": "Deny",
                  "bypass": "AzureServices",
                  "virtualNetworkRules": [],
                  "ipRules": []
                },
                "encryption": {
                  "requireInfrastructureEncryption": true,
                  "keySource": "Microsoft.Storage",
                  "services": {
                    "blob": {
                      "enabled": true,
                      "keyType": "Account"
                    },
                    "file": {
                      "enabled": true,
                      "keyType": "Account"
                    },
                    "table": {
                      "enabled": true,
                      "keyType": "Account"
                    },
                    "queue": {
                      "enabled": true,
                      "keyType": "Account"
                    }
                  }
                },
                "isHnsEnabled": false,
                "isNfsV3Enabled": false,
                "isSftpEnabled": false,
                "publicNetworkAccess": "Disabled"
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', take(variables('storageAccountName'), 24), 'default')]",
              "properties": {
                "deleteRetentionPolicy": {
                  "enabled": true,
                  "days": 7
                },
                "containerDeleteRetentionPolicy": {
                  "enabled": true,
                  "days": 7
                },
                "changeFeed": {
                  "enabled": true,
                  "retentionInDays": 7
                },
                "isVersioningEnabled": false
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', take(variables('storageAccountName'), 24))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}/{2}', take(variables('storageAccountName'), 24), 'default', 'unity-catalog')]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', take(variables('storageAccountName'), 24), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', take(variables('mlStorageAccountName'), 24), 'default')]",
              "properties": {
                "deleteRetentionPolicy": {
                  "enabled": true,
                  "days": 7
                },
                "containerDeleteRetentionPolicy": {
                  "enabled": true,
                  "days": 7
                },
                "changeFeed": {
                  "enabled": false
                },
                "isVersioningEnabled": false
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', take(variables('mlStorageAccountName'), 24))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}/{2}', take(variables('mlStorageAccountName'), 24), 'default', 'azureml')]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', take(variables('mlStorageAccountName'), 24), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2024-06-01",
              "name": "[format('privatelink.blob.{0}', environment().suffixes.storage)]",
              "location": "global",
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2024-06-01",
              "name": "[format('privatelink.dfs.{0}', environment().suffixes.storage)]",
              "location": "global",
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2024-06-01",
              "name": "[format('privatelink.file.{0}', environment().suffixes.storage)]",
              "location": "global",
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2024-06-01",
              "name": "[format('{0}/{1}', format('privatelink.blob.{0}', environment().suffixes.storage), 'blob-dns-link')]",
              "location": "global",
              "properties": {
                "registrationEnabled": false,
                "virtualNetwork": {
                  "id": "[parameters('vnetId')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', format('privatelink.blob.{0}', environment().suffixes.storage))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2024-06-01",
              "name": "[format('{0}/{1}', format('privatelink.dfs.{0}', environment().suffixes.storage), 'dfs-dns-link')]",
              "location": "global",
              "properties": {
                "registrationEnabled": false,
                "virtualNetwork": {
                  "id": "[parameters('vnetId')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', format('privatelink.dfs.{0}', environment().suffixes.storage))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2024-06-01",
              "name": "[format('{0}/{1}', format('privatelink.file.{0}', environment().suffixes.storage), 'file-dns-link')]",
              "location": "global",
              "properties": {
                "registrationEnabled": false,
                "virtualNetwork": {
                  "id": "[parameters('vnetId')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', format('privatelink.file.{0}', environment().suffixes.storage))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2024-01-01",
              "name": "[variables('blobPrivateEndpointName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('privateEndpointSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[variables('blobPrivateEndpointName')]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.Storage/storageAccounts', take(variables('storageAccountName'), 24))]",
                      "groupIds": [
                        "blob"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', take(variables('storageAccountName'), 24))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2024-01-01",
              "name": "[variables('dfsPrivateEndpointName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('privateEndpointSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[variables('dfsPrivateEndpointName')]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.Storage/storageAccounts', take(variables('storageAccountName'), 24))]",
                      "groupIds": [
                        "dfs"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', take(variables('storageAccountName'), 24))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2024-01-01",
              "name": "[variables('filePrivateEndpointName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('privateEndpointSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[variables('filePrivateEndpointName')]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.Storage/storageAccounts', take(variables('storageAccountName'), 24))]",
                      "groupIds": [
                        "file"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', take(variables('storageAccountName'), 24))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2024-01-01",
              "name": "[variables('mlBlobPrivateEndpointName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('privateEndpointSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[variables('mlBlobPrivateEndpointName')]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.Storage/storageAccounts', take(variables('mlStorageAccountName'), 24))]",
                      "groupIds": [
                        "blob"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', take(variables('mlStorageAccountName'), 24))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2024-01-01",
              "name": "[variables('mlFilePrivateEndpointName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('privateEndpointSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[variables('mlFilePrivateEndpointName')]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.Storage/storageAccounts', take(variables('mlStorageAccountName'), 24))]",
                      "groupIds": [
                        "file"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', take(variables('mlStorageAccountName'), 24))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}/{1}', variables('blobPrivateEndpointName'), 'blob-dns-zone-group')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "config",
                    "properties": {
                      "privateDnsZoneId": "[resourceId('Microsoft.Network/privateDnsZones', format('privatelink.blob.{0}', environment().suffixes.storage))]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', format('privatelink.blob.{0}', environment().suffixes.storage))]",
                "[resourceId('Microsoft.Network/privateEndpoints', variables('blobPrivateEndpointName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}/{1}', variables('dfsPrivateEndpointName'), 'dfs-dns-zone-group')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "config",
                    "properties": {
                      "privateDnsZoneId": "[resourceId('Microsoft.Network/privateDnsZones', format('privatelink.dfs.{0}', environment().suffixes.storage))]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', format('privatelink.dfs.{0}', environment().suffixes.storage))]",
                "[resourceId('Microsoft.Network/privateEndpoints', variables('dfsPrivateEndpointName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}/{1}', variables('filePrivateEndpointName'), 'file-dns-zone-group')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "config",
                    "properties": {
                      "privateDnsZoneId": "[resourceId('Microsoft.Network/privateDnsZones', format('privatelink.file.{0}', environment().suffixes.storage))]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', format('privatelink.file.{0}', environment().suffixes.storage))]",
                "[resourceId('Microsoft.Network/privateEndpoints', variables('filePrivateEndpointName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}/{1}', variables('mlBlobPrivateEndpointName'), 'ml-blob-dns-zone-group')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "config",
                    "properties": {
                      "privateDnsZoneId": "[resourceId('Microsoft.Network/privateDnsZones', format('privatelink.blob.{0}', environment().suffixes.storage))]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', format('privatelink.blob.{0}', environment().suffixes.storage))]",
                "[resourceId('Microsoft.Network/privateEndpoints', variables('mlBlobPrivateEndpointName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}/{1}', variables('mlFilePrivateEndpointName'), 'ml-file-dns-zone-group')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "config",
                    "properties": {
                      "privateDnsZoneId": "[resourceId('Microsoft.Network/privateDnsZones', format('privatelink.file.{0}', environment().suffixes.storage))]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', format('privatelink.file.{0}', environment().suffixes.storage))]",
                "[resourceId('Microsoft.Network/privateEndpoints', variables('mlFilePrivateEndpointName'))]"
              ]
            }
          ],
          "outputs": {
            "storageAccountId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Storage/storageAccounts', take(variables('storageAccountName'), 24))]"
            },
            "storageAccountName": {
              "type": "string",
              "value": "[take(variables('storageAccountName'), 24)]"
            },
            "blobEndpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', take(variables('storageAccountName'), 24)), '2023-05-01').primaryEndpoints.blob]"
            },
            "dfsEndpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', take(variables('storageAccountName'), 24)), '2023-05-01').primaryEndpoints.dfs]"
            },
            "mlStorageAccountId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Storage/storageAccounts', take(variables('mlStorageAccountName'), 24))]"
            },
            "mlStorageAccountName": {
              "type": "string",
              "value": "[take(variables('mlStorageAccountName'), 24)]"
            },
            "mlBlobEndpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', take(variables('mlStorageAccountName'), 24)), '2023-05-01').primaryEndpoints.blob]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'networking-deployment')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "keyvault-deployment",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "projectName": {
            "value": "[parameters('projectName')]"
          },
          "environmentName": {
            "value": "[parameters('environmentName')]"
          },
          "adminObjectId": {
            "value": "[parameters('adminObjectId')]"
          },
          "vnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'networking-deployment'), '2025-04-01').outputs.vnetId.value]"
          },
          "privateEndpointSubnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'networking-deployment'), '2025-04-01').outputs.privateEndpointSubnetId.value]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "13734527949297563125"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "projectName": {
              "type": "string"
            },
            "environmentName": {
              "type": "string"
            },
            "adminObjectId": {
              "type": "string"
            },
            "vnetId": {
              "type": "string"
            },
            "privateEndpointSubnetId": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            }
          },
          "variables": {
            "keyVaultName": "[format('kv-{0}-{1}-{2}', parameters('projectName'), parameters('environmentName'), uniqueString(resourceGroup().id))]",
            "privateEndpointName": "[format('pe-{0}', variables('keyVaultName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2024-04-01-preview",
              "name": "[take(variables('keyVaultName'), 24)]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "tenantId": "[subscription().tenantId]",
                "enableRbacAuthorization": true,
                "enableSoftDelete": true,
                "softDeleteRetentionInDays": 90,
                "enablePurgeProtection": true,
                "publicNetworkAccess": "Disabled",
                "networkAcls": {
                  "defaultAction": "Deny",
                  "bypass": "AzureServices",
                  "ipRules": [],
                  "virtualNetworkRules": []
                }
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[resourceId('Microsoft.KeyVault/vaults', take(variables('keyVaultName'), 24))]",
              "name": "[guid(resourceId('Microsoft.KeyVault/vaults', take(variables('keyVaultName'), 24)), parameters('adminObjectId'), 'KeyVaultAdministrator')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '00482a5a-887f-4fb3-b363-3b7fe8e74483')]",
                "principalId": "[parameters('adminObjectId')]",
                "principalType": "User"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', take(variables('keyVaultName'), 24))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2024-06-01",
              "name": "privatelink.vaultcore.azure.net",
              "location": "global",
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2024-06-01",
              "name": "[format('{0}/{1}', 'privatelink.vaultcore.azure.net', 'kv-dns-link')]",
              "location": "global",
              "properties": {
                "registrationEnabled": false,
                "virtualNetwork": {
                  "id": "[parameters('vnetId')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.vaultcore.azure.net')]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2024-01-01",
              "name": "[variables('privateEndpointName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('privateEndpointSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[variables('privateEndpointName')]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.KeyVault/vaults', take(variables('keyVaultName'), 24))]",
                      "groupIds": [
                        "vault"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', take(variables('keyVaultName'), 24))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}/{1}', variables('privateEndpointName'), 'vault-dns-zone-group')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "config",
                    "properties": {
                      "privateDnsZoneId": "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.vaultcore.azure.net')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.vaultcore.azure.net')]",
                "[resourceId('Microsoft.Network/privateEndpoints', variables('privateEndpointName'))]"
              ]
            }
          ],
          "outputs": {
            "keyVaultId": {
              "type": "string",
              "value": "[resourceId('Microsoft.KeyVault/vaults', take(variables('keyVaultName'), 24))]"
            },
            "keyVaultName": {
              "type": "string",
              "value": "[take(variables('keyVaultName'), 24)]"
            },
            "keyVaultUri": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults', take(variables('keyVaultName'), 24)), '2024-04-01-preview').vaultUri]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'networking-deployment')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "acr-deployment",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "projectName": {
            "value": "[parameters('projectName')]"
          },
          "environmentName": {
            "value": "[parameters('environmentName')]"
          },
          "vnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'networking-deployment'), '2025-04-01').outputs.vnetId.value]"
          },
          "privateEndpointSubnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'networking-deployment'), '2025-04-01').outputs.privateEndpointSubnetId.value]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "527089513800603345"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "projectName": {
              "type": "string"
            },
            "environmentName": {
              "type": "string"
            },
            "vnetId": {
              "type": "string"
            },
            "privateEndpointSubnetId": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            }
          },
          "variables": {
            "acrName": "[format('acr{0}{1}{2}', replace(parameters('projectName'), '-', ''), parameters('environmentName'), uniqueString(resourceGroup().id))]",
            "privateEndpointName": "[format('pe-{0}', variables('acrName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.ContainerRegistry/registries",
              "apiVersion": "2023-11-01-preview",
              "name": "[take(variables('acrName'), 50)]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Premium"
              },
              "properties": {
                "adminUserEnabled": false,
                "anonymousPullEnabled": false,
                "publicNetworkAccess": "Disabled",
                "networkRuleBypassOptions": "AzureServices",
                "zoneRedundancy": "Disabled",
                "encryption": {
                  "status": "disabled"
                },
                "dataEndpointEnabled": true,
                "networkRuleSet": {
                  "defaultAction": "Deny"
                },
                "policies": {
                  "quarantinePolicy": {
                    "status": "enabled"
                  },
                  "trustPolicy": {
                    "type": "Notary",
                    "status": "enabled"
                  },
                  "retentionPolicy": {
                    "days": 30,
                    "status": "enabled"
                  },
                  "softDeletePolicy": {
                    "status": "disabled"
                  }
                }
              }
            },
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2024-06-01",
              "name": "privatelink.azurecr.io",
              "location": "global",
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2024-06-01",
              "name": "[format('{0}/{1}', 'privatelink.azurecr.io', 'acr-dns-link')]",
              "location": "global",
              "properties": {
                "registrationEnabled": false,
                "virtualNetwork": {
                  "id": "[parameters('vnetId')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.azurecr.io')]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2024-01-01",
              "name": "[variables('privateEndpointName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('privateEndpointSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[variables('privateEndpointName')]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.ContainerRegistry/registries', take(variables('acrName'), 50))]",
                      "groupIds": [
                        "registry"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.ContainerRegistry/registries', take(variables('acrName'), 50))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}/{1}', variables('privateEndpointName'), 'registry-dns-zone-group')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "config",
                    "properties": {
                      "privateDnsZoneId": "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.azurecr.io')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.azurecr.io')]",
                "[resourceId('Microsoft.Network/privateEndpoints', variables('privateEndpointName'))]"
              ]
            }
          ],
          "outputs": {
            "acrId": {
              "type": "string",
              "value": "[resourceId('Microsoft.ContainerRegistry/registries', take(variables('acrName'), 50))]"
            },
            "acrName": {
              "type": "string",
              "value": "[take(variables('acrName'), 50)]"
            },
            "acrLoginServer": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ContainerRegistry/registries', take(variables('acrName'), 50)), '2023-11-01-preview').loginServer]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'networking-deployment')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]"
      ]
    },
    {
      "condition": "[or(parameters('deployAzureML'), parameters('deployAIFoundry'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "azureml-dns",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "vnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'networking-deployment'), '2025-04-01').outputs.vnetId.value]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "10749789727501745766"
            }
          },
          "parameters": {
            "vnetId": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2024-06-01",
              "name": "privatelink.api.azureml.ms",
              "location": "global",
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2024-06-01",
              "name": "[format('{0}/{1}', 'privatelink.api.azureml.ms', 'aml-dns-link')]",
              "location": "global",
              "properties": {
                "registrationEnabled": false,
                "virtualNetwork": {
                  "id": "[parameters('vnetId')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.api.azureml.ms')]"
              ]
            }
          ],
          "outputs": {
            "privateDnsZoneId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.api.azureml.ms')]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'networking-deployment')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]"
      ]
    },
    {
      "condition": "[parameters('deployAzureML')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "azureml-deployment",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "projectName": {
            "value": "[parameters('projectName')]"
          },
          "environmentName": {
            "value": "[parameters('environmentName')]"
          },
          "storageAccountId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.mlStorageAccountId.value]"
          },
          "keyVaultId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'keyvault-deployment'), '2025-04-01').outputs.keyVaultId.value]"
          },
          "containerRegistryId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'acr-deployment'), '2025-04-01').outputs.acrId.value]"
          },
          "privateEndpointSubnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'networking-deployment'), '2025-04-01').outputs.privateEndpointSubnetId.value]"
          },
          "computeSubnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'networking-deployment'), '2025-04-01').outputs.azureMLComputeSubnetId.value]"
          },
          "privateDnsZoneId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'azureml-dns'), '2025-04-01').outputs.privateDnsZoneId.value]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "12089673055909494203"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "projectName": {
              "type": "string"
            },
            "environmentName": {
              "type": "string"
            },
            "storageAccountId": {
              "type": "string"
            },
            "keyVaultId": {
              "type": "string"
            },
            "containerRegistryId": {
              "type": "string"
            },
            "privateEndpointSubnetId": {
              "type": "string"
            },
            "computeSubnetId": {
              "type": "string"
            },
            "privateDnsZoneId": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            }
          },
          "variables": {
            "workspaceName": "[format('aml-{0}-{1}', parameters('projectName'), parameters('environmentName'))]",
            "applicationInsightsName": "[format('appi-{0}-{1}', parameters('projectName'), parameters('environmentName'))]",
            "privateEndpointName": "[format('pe-aml-{0}-{1}', parameters('projectName'), parameters('environmentName'))]",
            "storageAccountName": "[split(parameters('storageAccountId'), '/')[8]]",
            "keyVaultName": "[split(parameters('keyVaultId'), '/')[8]]"
          },
          "resources": [
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[variables('applicationInsightsName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "web",
              "properties": {
                "Application_Type": "web",
                "RetentionInDays": 90,
                "publicNetworkAccessForIngestion": "Disabled",
                "publicNetworkAccessForQuery": "Disabled"
              }
            },
            {
              "type": "Microsoft.MachineLearningServices/workspaces",
              "apiVersion": "2024-04-01",
              "name": "[variables('workspaceName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Basic",
                "tier": "Basic"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "friendlyName": "[variables('workspaceName')]",
                "storageAccount": "[parameters('storageAccountId')]",
                "keyVault": "[parameters('keyVaultId')]",
                "applicationInsights": "[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]",
                "containerRegistry": "[parameters('containerRegistryId')]",
                "publicNetworkAccess": "Disabled",
                "imageBuildCompute": "cpu-cluster",
                "description": "Secure Azure ML workspace with network integration",
                "discoveryUrl": null
              },
              "dependsOn": [
                "[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]",
              "name": "[guid(parameters('storageAccountId'), resourceId('Microsoft.MachineLearningServices/workspaces', variables('workspaceName')), 'StorageBlobDataReader')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '2a2b9908-6ea1-4ae2-8e65-a410df84e7d1')]",
                "principalId": "[reference(resourceId('Microsoft.MachineLearningServices/workspaces', variables('workspaceName')), '2024-04-01', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.MachineLearningServices/workspaces', variables('workspaceName'))]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]",
              "name": "[guid(parameters('keyVaultId'), resourceId('Microsoft.MachineLearningServices/workspaces', variables('workspaceName')), 'KeyVaultAdmin')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '00482a5a-887f-4fb3-b363-3b7fe8e74483')]",
                "principalId": "[reference(resourceId('Microsoft.MachineLearningServices/workspaces', variables('workspaceName')), '2024-04-01', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.MachineLearningServices/workspaces', variables('workspaceName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2024-01-01",
              "name": "[variables('privateEndpointName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('privateEndpointSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[variables('privateEndpointName')]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.MachineLearningServices/workspaces', variables('workspaceName'))]",
                      "groupIds": [
                        "amlworkspace"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.MachineLearningServices/workspaces', variables('workspaceName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}/{1}', variables('privateEndpointName'), 'aml-dns-zone-group')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "config",
                    "properties": {
                      "privateDnsZoneId": "[parameters('privateDnsZoneId')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', variables('privateEndpointName'))]"
              ]
            },
            {
              "type": "Microsoft.MachineLearningServices/workspaces/computes",
              "apiVersion": "2024-04-01",
              "name": "[format('{0}/{1}', variables('workspaceName'), 'cpu-cluster')]",
              "location": "[parameters('location')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "computeType": "AmlCompute",
                "computeLocation": "[parameters('location')]",
                "description": "Azure ML CPU compute cluster",
                "properties": {
                  "vmSize": "Standard_DS3_v2",
                  "vmPriority": "Dedicated",
                  "scaleSettings": {
                    "maxNodeCount": 10,
                    "minNodeCount": 0,
                    "nodeIdleTimeBeforeScaleDown": "PT15M"
                  },
                  "userAccountCredentials": null,
                  "subnet": {
                    "id": "[parameters('computeSubnetId')]"
                  },
                  "remoteLoginPortPublicAccess": "Disabled",
                  "isolatedNetwork": false
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.MachineLearningServices/workspaces', variables('workspaceName'))]"
              ]
            }
          ],
          "outputs": {
            "workspaceName": {
              "type": "string",
              "value": "[variables('workspaceName')]"
            },
            "workspaceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.MachineLearningServices/workspaces', variables('workspaceName'))]"
            },
            "applicationInsightsId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'azureml-dns')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'acr-deployment')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'keyvault-deployment')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'networking-deployment')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'storage-deployment')]"
      ]
    },
    {
      "condition": "[parameters('deployAIFoundry')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "ai-foundry-deployment",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "projectName": {
            "value": "[parameters('projectName')]"
          },
          "environmentName": {
            "value": "[parameters('environmentName')]"
          },
          "storageAccountId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.mlStorageAccountId.value]"
          },
          "keyVaultId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'keyvault-deployment'), '2025-04-01').outputs.keyVaultId.value]"
          },
          "containerRegistryId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'acr-deployment'), '2025-04-01').outputs.acrId.value]"
          },
          "privateEndpointSubnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'networking-deployment'), '2025-04-01').outputs.privateEndpointSubnetId.value]"
          },
          "privateDnsZoneId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'azureml-dns'), '2025-04-01').outputs.privateDnsZoneId.value]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "9496383280719911432"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "projectName": {
              "type": "string"
            },
            "environmentName": {
              "type": "string"
            },
            "storageAccountId": {
              "type": "string"
            },
            "keyVaultId": {
              "type": "string"
            },
            "containerRegistryId": {
              "type": "string"
            },
            "privateEndpointSubnetId": {
              "type": "string"
            },
            "privateDnsZoneId": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            }
          },
          "variables": {
            "hubName": "[format('aihub-{0}-{1}', parameters('projectName'), parameters('environmentName'))]",
            "privateEndpointName": "[format('pe-aihub-{0}-{1}', parameters('projectName'), parameters('environmentName'))]",
            "storageAccountName": "[split(parameters('storageAccountId'), '/')[8]]",
            "keyVaultName": "[split(parameters('keyVaultId'), '/')[8]]"
          },
          "resources": [
            {
              "type": "Microsoft.MachineLearningServices/workspaces",
              "apiVersion": "2024-04-01",
              "name": "[variables('hubName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "Hub",
              "sku": {
                "name": "Basic",
                "tier": "Basic"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "friendlyName": "[variables('hubName')]",
                "storageAccount": "[parameters('storageAccountId')]",
                "keyVault": "[parameters('keyVaultId')]",
                "containerRegistry": "[parameters('containerRegistryId')]",
                "publicNetworkAccess": "Disabled",
                "description": "Azure AI Foundry Hub with network integration",
                "hubResourceId": null
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]",
              "name": "[guid(parameters('storageAccountId'), resourceId('Microsoft.MachineLearningServices/workspaces', variables('hubName')), 'StorageBlobDataReader')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '2a2b9908-6ea1-4ae2-8e65-a410df84e7d1')]",
                "principalId": "[reference(resourceId('Microsoft.MachineLearningServices/workspaces', variables('hubName')), '2024-04-01', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.MachineLearningServices/workspaces', variables('hubName'))]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]",
              "name": "[guid(parameters('keyVaultId'), resourceId('Microsoft.MachineLearningServices/workspaces', variables('hubName')), 'KeyVaultAdmin')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '00482a5a-887f-4fb3-b363-3b7fe8e74483')]",
                "principalId": "[reference(resourceId('Microsoft.MachineLearningServices/workspaces', variables('hubName')), '2024-04-01', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.MachineLearningServices/workspaces', variables('hubName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2024-01-01",
              "name": "[variables('privateEndpointName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('privateEndpointSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[variables('privateEndpointName')]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.MachineLearningServices/workspaces', variables('hubName'))]",
                      "groupIds": [
                        "amlworkspace"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.MachineLearningServices/workspaces', variables('hubName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}/{1}', variables('privateEndpointName'), 'aihub-dns-zone-group')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "config",
                    "properties": {
                      "privateDnsZoneId": "[parameters('privateDnsZoneId')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', variables('privateEndpointName'))]"
              ]
            }
          ],
          "outputs": {
            "hubName": {
              "type": "string",
              "value": "[variables('hubName')]"
            },
            "hubId": {
              "type": "string",
              "value": "[resourceId('Microsoft.MachineLearningServices/workspaces', variables('hubName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'azureml-dns')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'acr-deployment')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'keyvault-deployment')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'networking-deployment')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'storage-deployment')]"
      ]
    },
    {
      "condition": "[parameters('deployAKS')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "aks-deployment",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "projectName": {
            "value": "[parameters('projectName')]"
          },
          "environmentName": {
            "value": "[parameters('environmentName')]"
          },
          "aksSubnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'networking-deployment'), '2025-04-01').outputs.aksSubnetId.value]"
          },
          "nodeCount": {
            "value": "[parameters('aksNodeCount')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "7369763130023691337"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "projectName": {
              "type": "string"
            },
            "environmentName": {
              "type": "string"
            },
            "aksSubnetId": {
              "type": "string"
            },
            "nodeCount": {
              "type": "int"
            },
            "tags": {
              "type": "object"
            }
          },
          "variables": {
            "clusterName": "[format('aks-{0}-{1}', parameters('projectName'), parameters('environmentName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.ContainerService/managedClusters",
              "apiVersion": "2024-02-01",
              "name": "[variables('clusterName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Base",
                "tier": "Standard"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "dnsPrefix": "[variables('clusterName')]",
                "kubernetesVersion": "1.29",
                "enableRBAC": true,
                "enablePodSecurityPolicy": false,
                "networkProfile": {
                  "networkPlugin": "azure",
                  "networkPluginMode": "overlay",
                  "networkDataplane": "cilium",
                  "dnsServiceIP": "10.1.0.10",
                  "serviceCidr": "10.1.0.0/16",
                  "outboundType": "loadBalancer",
                  "loadBalancerSku": "standard"
                },
                "agentPoolProfiles": [
                  {
                    "name": "systempool",
                    "count": "[parameters('nodeCount')]",
                    "vmSize": "Standard_DS3_v2",
                    "osType": "Linux",
                    "osSKU": "AzureLinux",
                    "maxCount": 10,
                    "minCount": 1,
                    "enableAutoScaling": true,
                    "enableNodePublicIP": false,
                    "type": "VirtualMachineScaleSets",
                    "mode": "System",
                    "vnetSubnetID": "[parameters('aksSubnetId')]",
                    "podSubnetID": "[parameters('aksSubnetId')]",
                    "nodeTaints": []
                  },
                  {
                    "name": "userpool",
                    "count": "[parameters('nodeCount')]",
                    "vmSize": "Standard_D4s_v3",
                    "osType": "Linux",
                    "osSKU": "AzureLinux",
                    "maxCount": 20,
                    "minCount": 0,
                    "enableAutoScaling": true,
                    "enableNodePublicIP": false,
                    "type": "VirtualMachineScaleSets",
                    "mode": "User",
                    "vnetSubnetID": "[parameters('aksSubnetId')]",
                    "podSubnetID": "[parameters('aksSubnetId')]",
                    "nodeTaints": [
                      "workload=inference:NoSchedule"
                    ]
                  }
                ],
                "apiServerAccessProfile": {
                  "enablePrivateCluster": true,
                  "enablePrivateClusterPublicFQDN": false,
                  "privateDNSZone": "system",
                  "authorizedIPRanges": []
                },
                "autoUpgradeProfile": {
                  "upgradeChannel": "patch"
                },
                "addonProfiles": {
                  "omsagent": {
                    "enabled": true,
                    "config": {
                      "logAnalyticsWorkspaceResourceID": "[format('/subscriptions/{0}/resourcegroups/{1}/providers/microsoft.operationalinsights/workspaces/log-{2}-{3}', subscription().subscriptionId, resourceGroup().name, parameters('projectName'), parameters('environmentName'))]"
                    }
                  },
                  "azurepolicy": {
                    "enabled": true,
                    "config": {
                      "version": "v2"
                    }
                  },
                  "ingressApplicationGateway": {
                    "enabled": false
                  }
                },
                "securityProfile": {
                  "defender": {
                    "logAnalyticsWorkspaceResourceId": "[format('/subscriptions/{0}/resourcegroups/{1}/providers/microsoft.operationalinsights/workspaces/log-{2}-{3}', subscription().subscriptionId, resourceGroup().name, parameters('projectName'), parameters('environmentName'))]",
                    "securityMonitoring": {
                      "enabled": true
                    }
                  },
                  "imageCleaner": {
                    "enabled": true,
                    "intervalHours": 24
                  },
                  "azureKeyVaultKms": {
                    "enabled": false
                  },
                  "workloadIdentity": {
                    "enabled": true
                  }
                },
                "httpProxyConfig": {
                  "httpProxy": null,
                  "httpsProxy": null,
                  "noProxy": [],
                  "trustedCa": null
                },
                "storageProfile": {
                  "blobCSIDriver": {
                    "enabled": true
                  },
                  "diskCSIDriver": {
                    "enabled": true
                  },
                  "fileCSIDriver": {
                    "enabled": true
                  },
                  "snapshotController": {
                    "enabled": true
                  }
                }
              }
            }
          ],
          "outputs": {
            "aksClusterName": {
              "type": "string",
              "value": "[variables('clusterName')]"
            },
            "aksClusterResourceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.ContainerService/managedClusters', variables('clusterName'))]"
            },
            "fqdn": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ContainerService/managedClusters', variables('clusterName')), '2024-02-01').fqdn]"
            },
            "privateFqdn": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ContainerService/managedClusters', variables('clusterName')), '2024-02-01').privateFQDN]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'networking-deployment')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]"
      ]
    },
    {
      "condition": "[parameters('enableUnityCatalog')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "unity-catalog-deployment",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "projectName": {
            "value": "[parameters('projectName')]"
          },
          "environmentName": {
            "value": "[parameters('environmentName')]"
          },
          "databricksWorkspaceUrl": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'databricks-deployment'), '2025-04-01').outputs.workspaceUrl.value]"
          },
          "databricksWorkspaceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'databricks-deployment'), '2025-04-01').outputs.workspaceId.value]"
          },
          "storageAccountName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.storageAccountName.value]"
          },
          "storageContainerName": {
            "value": "unity-catalog"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "11429386317196062629"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "projectName": {
              "type": "string"
            },
            "environmentName": {
              "type": "string"
            },
            "databricksWorkspaceUrl": {
              "type": "string"
            },
            "databricksWorkspaceId": {
              "type": "string"
            },
            "storageAccountName": {
              "type": "string"
            },
            "storageContainerName": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            }
          },
          "variables": {
            "$fxv#0": "# Unity Catalog Auto-Configuration Script\r\n# Uses Access Connector managed identity for secure authentication\r\n# No shared keys required - fully managed identity-based access\r\n\r\nparam(\r\n    [string]$WorkspaceUrl,\r\n    [string]$WorkspaceId,\r\n    [string]$StorageAccountName,\r\n    [string]$StorageContainerName,\r\n    [string]$MetastoreName,\r\n    [string]$ProjectName,\r\n    [string]$Environment,\r\n    [string]$Location,\r\n    [string]$AccessConnectorId\r\n)\r\n\r\n$ErrorActionPreference = \"Stop\"\r\n\r\nWrite-Output \"Starting Unity Catalog Configuration with Access Connector...\"\r\nWrite-Output \"Workspace URL: $WorkspaceUrl\"\r\nWrite-Output \"Storage Account: $StorageAccountName\"\r\nWrite-Output \"Metastore Name: $MetastoreName\"\r\nWrite-Output \"Access Connector ID: $AccessConnectorId\"\r\n\r\n# ========== Get Databricks Token ==========\r\ntry {\r\n    $response = Invoke-RestMethod -Uri \"http://169.254.169.254/metadata/identity/oauth2/token?api-version=2017-09-01&resource=2ff814a6-3304-4ab8-85cb-cd0e6f879c1d\" `\r\n        -Method GET `\r\n        -Headers @{ \"Metadata\" = \"true\" } `\r\n        -ErrorAction Stop\r\n    \r\n    $databricksToken = $response.access_token\r\n    Write-Output \" Successfully obtained Databricks token\"\r\n}\r\ncatch {\r\n    Write-Error \"Failed to obtain Databricks token: $_\"\r\n    exit 1\r\n}\r\n\r\n$headers = @{\r\n    \"Authorization\" = \"Bearer $databricksToken\"\r\n    \"Content-Type\"  = \"application/json\"\r\n}\r\n\r\n# ========== Create Metastore ==========\r\n$storageRoot = \"abfss://${StorageContainerName}@${StorageAccountName}.dfs.core.windows.net/\"\r\n\r\n$metastorePayload = @{\r\n    name           = $MetastoreName\r\n    storage_root   = $storageRoot\r\n    region         = $Location\r\n    delta_sharing_scope = \"ALL\"\r\n} | ConvertTo-Json\r\n\r\ntry {\r\n    Write-Output \"Creating metastore with storage root: $storageRoot\"\r\n    \r\n    $metastoreResponse = Invoke-RestMethod -Uri \"${WorkspaceUrl}/api/2.0/unity-catalog/metastores\" `\r\n        -Method POST `\r\n        -Headers $headers `\r\n        -Body $metastorePayload `\r\n        -ErrorAction Stop\r\n    \r\n    $metastoreId = $metastoreResponse.metastore_id\r\n    Write-Output \" Metastore created successfully (ID: $metastoreId)\"\r\n}\r\ncatch {\r\n    if ($_ -match \"already exists\") {\r\n        Write-Output \" Metastore already exists, retrieving...\"\r\n        \r\n        $existingMetastores = Invoke-RestMethod -Uri \"${WorkspaceUrl}/api/2.0/unity-catalog/metastores\" `\r\n            -Method GET `\r\n            -Headers $headers `\r\n            -ErrorAction Stop\r\n        \r\n        $metastoreId = $existingMetastores.metastores[0].metastore_id\r\n        Write-Output \" Using existing metastore (ID: $metastoreId)\"\r\n    }\r\n    else {\r\n        Write-Error \"Failed to create metastore: $_\"\r\n        exit 1\r\n    }\r\n}\r\n\r\n# ========== Assign Metastore to Workspace ==========\r\n$assignPayload = @{\r\n    workspace_id = $WorkspaceId\r\n    metastore_id = $metastoreId\r\n    default_catalog_name = \"default\"\r\n} | ConvertTo-Json\r\n\r\ntry {\r\n    Write-Output \"Assigning metastore to workspace...\"\r\n    \r\n    Invoke-RestMethod -Uri \"${WorkspaceUrl}/api/2.0/unity-catalog/workspaces/${WorkspaceId}/metastores\" `\r\n        -Method PUT `\r\n        -Headers $headers `\r\n        -Body $assignPayload `\r\n        -ErrorAction Stop\r\n    \r\n    Write-Output \" Metastore assigned to workspace\"\r\n}\r\ncatch {\r\n    Write-Warning \"Could not assign metastore: $_\"\r\n}\r\n\r\n# ========== Create Catalogs ==========\r\n$catalogNames = @(\"${Environment}_lob_team_1\", \"${Environment}_lob_team_2\", \"${Environment}_lob_team_3\")\r\n\r\nforeach ($catalogName in $catalogNames) {\r\n    $catalogPayload = @{\r\n        name = $catalogName\r\n        comment = \"Catalog for Line of Business\"\r\n    } | ConvertTo-Json\r\n    \r\n    try {\r\n        Write-Output \"Creating catalog: $catalogName\"\r\n        \r\n        Invoke-RestMethod -Uri \"${WorkspaceUrl}/api/2.0/unity-catalog/catalogs\" `\r\n            -Method POST `\r\n            -Headers $headers `\r\n            -Body $catalogPayload `\r\n            -ErrorAction Stop\r\n        \r\n        Write-Output \" Catalog $catalogName created\"\r\n    }\r\n    catch {\r\n        if ($_ -match \"already exists\") {\r\n            Write-Output \" Catalog $catalogName already exists\"\r\n        }\r\n    }\r\n    \r\n    # ========== Create Schemas ==========\r\n    $schemaNames = @(\"bronze\", \"silver\", \"gold\")\r\n    \r\n    foreach ($schemaName in $schemaNames) {\r\n        $schemaPayload = @{\r\n            name = $schemaName\r\n            catalog_name = $catalogName\r\n            comment = \"$schemaName schema\"\r\n        } | ConvertTo-Json\r\n        \r\n        try {\r\n            Invoke-RestMethod -Uri \"${WorkspaceUrl}/api/2.0/unity-catalog/schemas\" `\r\n                -Method POST `\r\n                -Headers $headers `\r\n                -Body $schemaPayload `\r\n                -ErrorAction Stop\r\n            \r\n            Write-Output \" Schema ${catalogName}.${schemaName} created\"\r\n        }\r\n        catch {\r\n            if ($_ -match \"already exists\") {\r\n                Write-Output \" Schema ${catalogName}.${schemaName} already exists\"\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\nWrite-Output \" Unity Catalog configuration complete!\"\r\n",
            "deploymentScriptName": "[format('deploy-unity-catalog-{0}-{1}', parameters('projectName'), parameters('environmentName'))]",
            "metastoreName": "[format('metastore-{0}-{1}', parameters('projectName'), parameters('environmentName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-01-31",
              "name": "[format('uai-unity-catalog-{0}-{1}', parameters('projectName'), parameters('environmentName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.Resources/deploymentScripts",
              "apiVersion": "2023-08-01",
              "name": "[variables('deploymentScriptName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "AzurePowerShell",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('uai-unity-catalog-{0}-{1}', parameters('projectName'), parameters('environmentName'))))]": {}
                }
              },
              "properties": {
                "azPowerShellVersion": "11.0",
                "timeout": "PT1H",
                "arguments": "[format('-WorkspaceUrl \"{0}\" -WorkspaceId \"{1}\" -StorageAccountName \"{2}\" -StorageContainerName \"{3}\" -MetastoreName \"{4}\" -ProjectName \"{5}\" -Environment \"{6}\" -Location \"{7}\" -AccessConnectorId \"{8}\"', parameters('databricksWorkspaceUrl'), parameters('databricksWorkspaceId'), parameters('storageAccountName'), parameters('storageContainerName'), variables('metastoreName'), parameters('projectName'), parameters('environmentName'), parameters('location'), reference(resourceId('Microsoft.Resources/deployments', format('access-connector-{0}-{1}', parameters('projectName'), parameters('environmentName'))), '2025-04-01').outputs.accessConnectorId.value)]",
                "scriptContent": "[variables('$fxv#0')]",
                "cleanupPreference": "OnSuccess",
                "retentionInterval": "PT1H"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', format('access-connector-{0}-{1}', parameters('projectName'), parameters('environmentName')))]",
                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('uai-unity-catalog-{0}-{1}', parameters('projectName'), parameters('environmentName')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('access-connector-{0}-{1}', parameters('projectName'), parameters('environmentName'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "projectName": {
                    "value": "[parameters('projectName')]"
                  },
                  "environmentName": {
                    "value": "[parameters('environmentName')]"
                  },
                  "storageAccountName": {
                    "value": "[parameters('storageAccountName')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.40.2.10011",
                      "templateHash": "15853279932777322843"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "projectName": {
                      "type": "string"
                    },
                    "environmentName": {
                      "type": "string"
                    },
                    "storageAccountName": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object"
                    }
                  },
                  "variables": {
                    "accessConnectorName": "[format('ac-{0}-{1}', parameters('projectName'), parameters('environmentName'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Databricks/accessConnectors",
                      "apiVersion": "2023-05-01",
                      "name": "[variables('accessConnectorName')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "identity": {
                        "type": "SystemAssigned"
                      },
                      "properties": {}
                    },
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]",
                      "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), resourceId('Microsoft.Databricks/accessConnectors', variables('accessConnectorName')), 'StorageBlobDataContributor')]",
                      "properties": {
                        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
                        "principalId": "[reference(resourceId('Microsoft.Databricks/accessConnectors', variables('accessConnectorName')), '2023-05-01', 'full').identity.principalId]",
                        "principalType": "ServicePrincipal"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Databricks/accessConnectors', variables('accessConnectorName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "accessConnectorId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Databricks/accessConnectors', variables('accessConnectorName'))]"
                    },
                    "accessConnectorName": {
                      "type": "string",
                      "value": "[variables('accessConnectorName')]"
                    },
                    "principalId": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Databricks/accessConnectors', variables('accessConnectorName')), '2023-05-01', 'full').identity.principalId]"
                    }
                  }
                }
              }
            }
          ],
          "outputs": {
            "metastoreName": {
              "type": "string",
              "value": "[variables('metastoreName')]"
            },
            "accessConnectorId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', format('access-connector-{0}-{1}', parameters('projectName'), parameters('environmentName'))), '2025-04-01').outputs.accessConnectorId.value]"
            },
            "metastoreId": {
              "type": "string",
              "value": "[coalesce(reference(resourceId('Microsoft.Resources/deploymentScripts', variables('deploymentScriptName')), '2023-08-01').outputs.metastoreId, '')]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'databricks-deployment')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'storage-deployment')]"
      ]
    }
  ],
  "outputs": {
    "resourceGroupName": {
      "type": "string",
      "value": "[variables('resourceGroupName')]"
    },
    "databricksWorkspaceUrl": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'databricks-deployment'), '2025-04-01').outputs.workspaceUrl.value]"
    },
    "databricksWorkspaceId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'databricks-deployment'), '2025-04-01').outputs.workspaceId.value]"
    },
    "storageAccountName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.storageAccountName.value]"
    },
    "keyVaultName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'keyvault-deployment'), '2025-04-01').outputs.keyVaultName.value]"
    },
    "containerRegistryName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'acr-deployment'), '2025-04-01').outputs.acrName.value]"
    },
    "azureMLWorkspaceName": {
      "type": "string",
      "value": "[if(parameters('deployAzureML'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'azureml-deployment'), '2025-04-01').outputs.workspaceName.value, 'Not deployed')]"
    },
    "aiFoundryHubName": {
      "type": "string",
      "value": "[if(parameters('deployAIFoundry'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'ai-foundry-deployment'), '2025-04-01').outputs.hubName.value, 'Not deployed')]"
    },
    "aksClusterName": {
      "type": "string",
      "value": "[if(parameters('deployAKS'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'aks-deployment'), '2025-04-01').outputs.aksClusterName.value, 'Not deployed')]"
    },
    "unityCatalogMetastoreName": {
      "type": "string",
      "value": "See deployment logs for Unity Catalog metastore details"
    },
    "vnetName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'networking-deployment'), '2025-04-01').outputs.vnetName.value]"
    }
  }
}